<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index</title>
    <style>
        .root {
            padding: 0 20px;
        }

        input,
        select {
            padding: 1px;
            margin-right: 15px;
        }

        .buff-list-container {
            z-index: 3;
            position: fixed;
            left: 100px;
            top: 20px;
            display: inline-block;
        }

        .buff-list-container>label {
            display: inline-block;
            padding: 5px 20px;
            border-style: solid;
            border-radius: 5px;
            background-color: white;
        }

        #buff_list {
            visibility: hidden;
            position: absolute;
            margin: 0;
            top: 0;
            left: 98%;
            padding-left: 10px;
            overflow: auto;
            min-width: 75vw;
            max-height: 90vh;
            background-color: white;
        }

        .buff-list-container:hover>#buff_list {
            visibility: visible;
        }


        #buff_list>table>tr:hover {
            background-color: skyblue;
        }

        .action-container {
            position: relative;
        }


        .action-title {
            color: darkblue;
            margin-bottom: 0;
        }

        /* #display {
            background-color: #F0F4F8;
        } */

        .buff-add {
            /* font-family: monospace; */
            background-color: #E8F5E9;
            font-size: 0.8em;
            color: #2E7D32;
            border-radius: 2px;
            padding: 1px;
        }

        .buff-remove {
            /* font-family: monospace; */
            background-color: #FFCCBC;
            font-size: 0.8em;
            color: #2E7D32;
            border-radius: 2px;
        }

        .demage-nocheck {
            background-color: #E3F2FD;
            color: #0D47A1;
            border-radius: 2px;
        }

        .demage-correct {
            background-color: #87d9ff;
            color: #01579B;
            border-radius: 2px;
        }

        .demage-wrong {
            background-color: #FF6F00;
            color: #FFF3E0;
            border-radius: 2px;
        }

        .action-detail {
            font-family: monospace;
            margin: 5px 0 16px;
            background-color: #EEEEEE;
            color: #616161;
        }

        .action-buff {
            position: absolute;
            left: 32em;
            visibility: hidden;
            background-color: RGB(248, 248, 248);
            border-style: solid;
            border-width: 1px;
            border-radius: 3PX;
            padding: 0 1em;
            z-index: 2;
            overflow: auto;
            max-height: 80vh;
            font-family: monospace;
            font-size: 1.25em;
        }

        .action-container:hover>.action-buff {
            visibility: visible;
        }
    </style>
</head>

<body>
    <div class="root">
        <h2>说明</h2>
        <div>
            <p>切换配置 </p>
            <!-- 网页加载后下面这个表自动生成，原有内容清空 -->
            <form id="练度流程">
            </form>
        </div>
        <h2>声骸主词条</h2>
        <label for="声骸-1">声骸1:</label>
        <select id="声骸-1" onchange="更新页面()">
            <option value="22%暴击+150攻击">22%暴击+150攻击</option>
            <option value="44%爆伤+150攻击">44%爆伤+150攻击</option>
            <option value="30%属伤+100攻击">30%属伤+100攻击</option>
            <option value="30%攻击+100攻击">30%攻击+100攻击</option>
        </select>
        <label for="声骸-2">声骸2:</label>
        <select id="声骸-2" onchange="更新页面()">
            <option value="30%属伤+100攻击">30%属伤+100攻击</option>
            <option value="30%攻击+100攻击">30%攻击+100攻击</option>
            <option value="22%暴击+150攻击">22%暴击+150攻击</option>
            <option value="44%爆伤+150攻击">44%爆伤+150攻击</option>
        </select>
        <label for="声骸-3">声骸3:</label>
        <select id="声骸-3" onchange="更新页面()">
            <option value="30%属伤+100攻击">30%属伤+100攻击</option>
            <option value="30%攻击+100攻击">30%攻击+100攻击</option>
            <option value="18%攻击+2280生命">18%攻击+2280生命</option>
        </select>

        <label for="声骸-4">声骸4:</label>
        <select id="声骸-4" onchange="更新页面()">
            <option value="18%攻击+2280生命">18%攻击+2280生命</option>
        </select>
        <label for="声骸-5">声骸5:</label>
        <select id="声骸-5" onchange="更新页面()">
            <option value="18%攻击+2280生命">18%攻击+2280生命</option>
        </select>


        <h2>声骸副词条</h2>
        <label for="声骸-暴击">暴击:</label>
        <input type="number" id="声骸-暴击" value="40.5" min="0" max="52.5" step="8.4" onchange="更新页面()">
        <label for="声骸-爆伤">爆伤:</label>
        <input type="number" id="声骸-爆伤" value="82.2" min="0" max="105" step="16.8" onchange="更新页面()">
        <label for="声骸-大攻击">大攻击:</label>
        <input type="number" id="声骸-大攻击" value="8.6" min="0" max="58" step="9" onchange="更新页面()">
        <label for="声骸-小攻击">小攻击:</label>
        <input type="number" id="声骸-小攻击" value="40" min="0" max="250" step="40" onchange="更新页面()">
        <label for="声骸-普攻伤害加成">普攻伤害加成:</label>
        <input type="number" id="声骸-普攻伤害加成" value="0" min="0" max="58" step="9" onchange="更新页面()">
        <label for="声骸-重击伤害加成">重击伤害加成:</label>
        <input type="number" id="声骸-重击伤害加成" value="0" min="0" max="58" step="9" onchange="更新页面()">
        <label for="声骸-共鸣技能伤害加成">共鸣技能伤害加成:</label>
        <input type="number" id="声骸-共鸣技能伤害加成" value="0" min="0" max="58" step="9" onchange="更新页面()">
        <label for="声骸-共鸣解放伤害加成">共鸣解放伤害加成:</label>
        <input type="number" id="声骸-共鸣解放伤害加成" value="22.9" min="0" max="58" step="9" onchange="更新页面()">

        <h2>其他</h2>
        <label for="敌方等级">敌方等级:</label>
        <input type="number" id="敌方等级" value="100" step="10" onchange="更新页面()">
        <label for="敌方抗性">敌方抗性:</label>
        <input type="number" id="敌方抗性" value="20" step="10" onchange="更新页面()" placeholder="深塔20/60,大世界10/40">


        <h2>流程</h2>
        <div class="buff-list-container">
            <label>buff列表</label>
            <div id="buff_list">
                <!-- 网页加载后下面这个表自动生成，原有内容清空 -->
                <table></table>
            </div>
            <div style="display: inline-block; width: 10px; height: 1em;"></div>
        </div>

        <!-- 网页加载后 #summary 和 #display 内容自动生成，原有内容清空 -->
        <p id="summary"></p>
        <div id="display"></div>
    </div>

    <!-- 添加配置 -->
    <script>
        const 练度流程列表 = {} 
    </script>
    <script src="configs/carlotta_20.js"></script>
    <script src="configs/chun_20.js"></script>
    <script src="configs/jiyan_20.js"></script>
    <script src="configs/phobe_20.js"></script>
    <script src="configs/encore.js"></script>
    <script src="configs/jinxi.js"></script>
    <script src="configs/xiangliyao.js"></script>
    <script src="configs/changli.js"></script>
    <script src="configs/zanni.js"></script>
    <script src="configs/Cartethyia.js"></script>
    <script src="configs/zhezhi_20.js"></script>
    <script src="configs/Phrolova.js"></script>

    <script>

        const init = function () {

            const 参数设置 = {
                '声骸-1': undefined,
                '声骸-2': undefined,
                '声骸-3': undefined,
                '声骸-4': undefined,
                '声骸-5': undefined,
                '声骸-暴击': undefined,
                '声骸-爆伤': undefined,
                '声骸-大攻击': undefined,
                '声骸-小攻击': undefined,
                '声骸-普攻伤害加成': undefined,
                '声骸-重击伤害加成': undefined,
                '声骸-共鸣技能伤害加成': undefined,
                '声骸-共鸣解放伤害加成': undefined,
                '敌方等级': undefined,
                '敌方抗性': undefined
            }

            for (const key in 参数设置) {
                const ele = document.getElementById(key)
                参数设置[key] = ele.value
            }

            console.log(参数设置)

            const 主词条ref = {
                '22%暴击+150攻击': { 暴击: 22, 小攻击: 150 },
                '44%爆伤+150攻击': { 爆伤: 44, 小攻击: 150 },
                '30%属伤+100攻击': { 增伤: 30, 小攻击: 100 },
                '30%攻击+100攻击': { 大攻击: 30, 小攻击: 100 },
                '18%攻击+2280生命': { 大攻击: 18 },
            }
            const 声骸属性 = { 声骸: { 属性: {} } }
            for (let i = 1; i <= 5; ++i) {
                let 配置 = 参数设置['声骸-' + i]
                配置 = 主词条ref[配置]
                for (const key in 配置) {
                    声骸属性.声骸.属性[key] = (声骸属性.声骸.属性[key] || 0) + 配置[key]
                }
            }

            for (const key of ['暴击', '爆伤', '大攻击', '小攻击', '普攻伤害加成', '重击伤害加成', '共鸣技能伤害加成', '共鸣解放伤害加成',]) {
                let value = 参数设置['声骸-' + key]
                value = parseFloat(value)
                if (!value)
                    continue

                if (key.endsWith('伤害加成')) {
                    const 配置 = { 属性: {} }
                    声骸属性['声骸-副词条-' + key.slice(0, -4)] = 配置
                    配置.属性.增伤 = value
                    配置.标签 = key.slice(0, -4)
                }
                else {
                    声骸属性['声骸-副词条'] = 声骸属性['声骸-副词条'] || { 属性: {} }
                    const 配置 = 声骸属性['声骸-副词条']
                    配置.属性[key] = value
                }
            }

            for (const k in 声骸属性)
                声骸属性[k].标签 = 声骸属性[k].标签 ? 声骸属性[k].标签 + ',拉表' : '拉表'
            console.log('声骸属性', 声骸属性)

            Object.assign(this.buff_列表, 声骸属性)
            Object.assign(this.buff_列表,
                { 敌方属性: { 属性: { 敌方等级: parseInt(参数设置.敌方等级), 抗性: parseInt(参数设置.敌方抗性) } } })

            console.log('所有可用buff', this.buff_列表)

            const display_ele = document.getElementById('display')
            display_ele.textContent = ''
            const buff_list_ele = document.getElementById('buff_list').firstElementChild
            buff_list_ele.innerHTML = ''

            for (const buff_name in this.buff_列表) {
                const li = document.createElement('tr')
                buff_list_ele.appendChild(li)
                li.innerHTML = '<td style="color: darkblue">' + buff_name + '</td> <td>' + my_stringfy(this.buff_列表[buff_name]) + '</td>'
                li.dataset.buff_name = buff_name
            }


            this.buff_总结 = {} // { tag: { buff列表: {...}, 属性: {...} } }

            this.buff_统计 =
                Object.fromEntries(Object.entries(this.buff_列表).map(kv => [kv[0], 0])) // { buff_name: buff_count }

            this.倍率_sum = 0
            this.加深倍率_sum = 0
            this.伤害_sum = 0

            for (const buff in this.buff_列表)
                this.add_buff(buff, 0, false)

        }

        const 标签maskGetter = {
            enum: { max: 0 },
            get_order: function (标签) {
                if (this.enum[标签] === undefined)
                    return this.enum[标签] = (this.enum.max++)
                return this.enum[标签]
            },
            get_mask: function (标签组合) {
                if (标签组合 === undefined)
                    return 0
                标签组合 = 标签组合.split(',')
                let res = 0
                for (const 标签 of 标签组合)
                    res |= (1 << this.get_order(标签.trim()))
                return res
            },

        }

        const add_buff = function (buff_name, diff = 1, display = true) {
            const buff = this.buff_列表[buff_name]
            if (buff === undefined)
                alert(`无此buff: "${buff_name}"`)
            let buff适用标签
            {
                const 标签 = buff['标签']
                const mask = 标签maskGetter.get_mask(标签)
                buff适用标签 = mask.toString(2)
                this.buff_总结[buff适用标签] = this.buff_总结[buff适用标签] || {
                    mask: mask, 标签: buff['标签'], buff统计: {}, 属性: {}
                }
            }
            const 对应标签buff总结 = this.buff_总结[buff适用标签]

            {
                const tmp = 对应标签buff总结.buff统计
                tmp[buff_name] = (tmp[buff_name] || 0) + diff
                this.buff_统计[buff_name] += diff
            }

            for (const [buff_key, buff_value] of Object.entries(buff['属性'])) {
                对应标签buff总结.属性[buff_key] = (对应标签buff总结.属性[buff_key] || 0) + diff * buff_value
            }

            if (display) {
                // 显示
                const p_ele = document.createElement('p')
                p_ele.innerText = `${diff > 0 ? '+' : ''}${diff} ${buff_name} ${my_stringfy(buff)}`
                if (diff > 0) {
                    p_ele.classList.add('buff-add')
                }
                else {
                    p_ele.classList.add('buff-remove')
                }
                const display_ele = document.getElementById('display')
                display_ele.appendChild(p_ele)
            }


        }

        // 对于每一种buff的处理方式, 严格按此顺序执行，所以使用了Map
        const buff_handlers = new Map([
            ['倍率', (伤害计算细节, value = 0) => { 伤害计算细节.倍率 = value }],
            ['倍率提升', (伤害计算细节, value = 0) => { 伤害计算细节.倍率 *= (1 + value) }],
            ['倍率增加', (伤害计算细节, value = 0) => { 伤害计算细节.倍率 += value; 伤害计算细节.单位期望伤害 = 1 }],
            ['基础攻击', (伤害计算细节, value = 0) => { 伤害计算细节.基础攻击 = value }],
            ['大攻击', (伤害计算细节, value = 0) => { 伤害计算细节.攻击 = 伤害计算细节.基础攻击 * (1 + value / 100) }],
            ['小攻击', (伤害计算细节, value = 0) => {
                伤害计算细节.攻击 = 伤害计算细节.攻击 + value
                伤害计算细节.攻击系数 = 伤害计算细节.攻击 / 伤害计算细节.基础攻击
                伤害计算细节.不暴击伤害 = 伤害计算细节.倍率 * 伤害计算细节.攻击
            }],
            ['暴击', (伤害计算细节, value = 0) => { 伤害计算细节.暴击 = value / 100 }],
            ['爆伤', (伤害计算细节, value = 0) => { 伤害计算细节.爆伤 = value / 100 }],
            ['增伤', (伤害计算细节, value = 0) => {
                伤害计算细节.增伤 = value / 100 + 1
                伤害计算细节.不暴击伤害 *= 伤害计算细节.增伤
            }],
            ['加深', (伤害计算细节, value = 0) => {
                伤害计算细节.加深 = value / 100 + 1
                伤害计算细节.不暴击伤害 *= 伤害计算细节.加深
            }],
            // 抗性和地方等级默认0，方便看出错误
            ['抗性', (伤害计算细节, value = 0) => {
                伤害计算细节.抗性 = 1 - value / 100
                伤害计算细节.不暴击伤害 *= 伤害计算细节.抗性
            }],
            ['敌方等级', (伤害计算细节, value = 0) => { 伤害计算细节.防御 = (99 + value) }],
            ['减防', (伤害计算细节, value = 0) => { 伤害计算细节.防御 *= (1 - value / 100) }],
            ['无视防御', (伤害计算细节, value = 0) => { 伤害计算细节.防御 *= (1 - value / 100) }],
            ['等级', (伤害计算细节, value = 90) => {
                伤害计算细节.防御 = (value + 100) / (value + 100 + 伤害计算细节.防御)
                伤害计算细节.不暴击伤害 *= 伤害计算细节.防御
                伤害计算细节.单位期望伤害 = 伤害计算细节.不暴击伤害 / 伤害计算细节.倍率 * (1 + (伤害计算细节.暴击 * (伤害计算细节.爆伤 - 1)))
            }],
            // 可以自行添加任何buff，按合适的顺序计算
        ])

        // 对于浮点数x, 保留n位小数, 返回float
        const my_toFixed = (x, n) => parseFloat((x).toFixed(n))
        const my_toPrecision = (x, n) => parseFloat((x).toPrecision(n))
        const my_stringfy = (v) => {
            if (v instanceof Array)
                return '[' + v.map((x) => my_stringfy(x)).join(', ') + ']'
            if (v instanceof Object)
                return '{' + Object.entries(v).map((xy) => `${my_stringfy(xy[0])}: ${my_stringfy(xy[1])}`).join(', ') + '}'

            return JSON.stringify(v)
        }

        const add_action = function (action_name, 倍率, ...tags) {
            let 验证伤害 = undefined
            let 仅验证 = false
            action_name = action_name.trim()
            if (action_name.startsWith('/')) {
                let args = action_name.split(' ')
                if (args[0] == '/check') {
                    tags.push('实战')
                    验证伤害 = parseFloat(args[args.length - 1])
                    仅验证 = true
                }
                else {
                    alert('未知命令: ' + args[0])
                }
            }
            else {
                tags.push('拉表')
            }

            // 格式为 { 大攻击: xxx, 小攻击: xxx, 增伤: xxx, ... }
            const 适用buff总计 = { 倍率 }

            const 当前动作mask = 标签maskGetter.get_mask(tags.join(','))

            const 适用buff列表 = { ...this.buff_统计 }
            for (const buff in 适用buff列表)
                适用buff列表[buff] = [适用buff列表[buff], '不适用']

            for (const tag in this.buff_总结) {
                const data = this.buff_总结[tag]
                if ((当前动作mask & data.mask) !== data.mask)
                    continue
                for (const buff in data.buff统计)
                    适用buff列表[buff][1] = '适用'
                for (const [buff_key, buff_value] of Object.entries(data.属性)) {
                    适用buff总计[buff_key] = (适用buff总计[buff_key] || 0) + buff_value
                }
            }

            const 伤害计算细节 = {}

            for (const key in 适用buff总计) {
                if (buff_handlers.get(key) === undefined)
                    alert('未知buff类型: ' + key +
                        ', 可选: ' + JSON.stringify([...buff_handlers.keys()]) +
                        ', 可自行添加')
            }

            for (const [buff类别, buff_handler] of buff_handlers.entries()) {
                const buff值 = 适用buff总计[buff类别]
                if (buff值 !== undefined)
                    buff_handler(伤害计算细节, buff值)
                else
                    buff_handler(伤害计算细节)
            }

            let 不暴击伤害 = 伤害计算细节.不暴击伤害
            delete 伤害计算细节.不暴击伤害

            const 暴击伤害 = 不暴击伤害 * 伤害计算细节.爆伤
            const 伤害期望 = (暴击伤害 - 不暴击伤害) * Math.min(1, 伤害计算细节.暴击) + 不暴击伤害

            if (!仅验证) {
                this.倍率_sum += 伤害计算细节.倍率
                this.加深倍率_sum += 伤害计算细节.倍率 * 伤害计算细节.加深
                this.伤害_sum += 伤害期望
            }

            for (const [乘区, 精度] of Object.entries({ 单位期望伤害: 6, 攻击: 5, 攻击系数: 4, 倍率: 6, 暴击: 4, 爆伤: 4, 增伤: 4, 防御: 4 }))
                伤害计算细节[乘区] = my_toPrecision(伤害计算细节[乘区], 精度)

            const 伤害展示 = Object.fromEntries(Object.entries({ 伤害期望, 暴击伤害, 不暴击伤害 }).map((kv) => [kv[0], my_toPrecision(kv[1], 6)]))

            {
                const h_ele = document.createElement('p')
                h_ele.classList.add('action-title')
                if (验证伤害) {
                    const atol = (暴击伤害 - 验证伤害)
                    if (Math.abs(atol) > 1 + 验证伤害 * 0.001) {
                        h_ele.classList.add('demage-wrong')
                    }
                    else {
                        h_ele.classList.add('demage-correct')
                    }
                    const rtol = atol / 验证伤害
                    action_name += ` 误差${(rtol * 100).toFixed(2)}%`
                }
                else {
                    h_ele.classList.add('demage-nocheck')

                }
                h_ele.innerHTML = action_name + '<br/>' + my_stringfy(伤害展示)
                const p_ele = document.createElement('p')
                p_ele.classList.add('action-detail')
                p_ele.innerHTML = my_stringfy(伤害计算细节) + '<br/>标签: ' + tags.join(', ')

                const buff_ele = document.createElement('div')
                buff_ele.classList.add('action-buff')

                buff_ele.innerHTML += `buff统计:<br/>`
                for (const buff in 适用buff列表) {
                    const [value, 是否适用] = 适用buff列表[buff]
                    if (是否适用 === '适用')
                        buff_ele.innerHTML += `&nbsp;<span>+${value} ${buff}</span><br/>`
                    else
                        buff_ele.innerHTML += `&nbsp;<span style="color: rgb(160, 160, 160);">+${value} ${buff}</span><br/>`
                }

                const container = document.createElement('div')
                container.classList.add('action-container')
                container.appendChild(buff_ele)
                container.appendChild(h_ele)
                container.appendChild(p_ele)

                const display_ele = document.getElementById('display')
                display_ele.appendChild(container)
            }
        }

        const 总伤展示 = function () {

            this.倍率_sum = my_toFixed(this.倍率_sum, 4)
            this.加深倍率_sum = my_toFixed(this.加深倍率_sum, 4)
            this.伤害_sum = my_toFixed(this.伤害_sum, 1)

            document.getElementById('summary').textContent =
                `总倍率: ${this.倍率_sum} 总加深倍率: ${this.加深倍率_sum} 总伤害: ${this.伤害_sum}`
        }



        let 正在切换配置 = false

        let 当前练度流程


        const 更新页面 = () => {
            if (正在切换配置)
                return


            const instance = {
                add_buff,
                add_action,
                init,
                总伤展示,
                ...练度流程列表[当前练度流程],
            }
            instance.buff_列表 = { ...instance.buff_列表 }
            instance.init()
            instance.流程()
            instance.总伤展示()
        }

        const 切换配置 = (新配置) => {

            if (练度流程列表[新配置] === undefined)
                return

            正在切换配置 = true
            console.log('切换至', 新配置)
            当前练度流程 = 新配置

            const 声骸配置 = 练度流程列表[当前练度流程]['声骸配置']
            for (const item in 声骸配置) {
                document.getElementById(item).value = 声骸配置[item]
            }

            document.title = 当前练度流程
            const url = new URL(window.location.href)
            url.searchParams.set('config', 当前练度流程)
            window.history.pushState({}, '', url.href)

            正在切换配置 = false
            更新页面()
        }

        {

            const form_ele = document.getElementById('练度流程')
            form_ele.innerHTML = ''
            const config = (new URL(window.location.href)).searchParams.get('config')

            for (const 练度流程name in 练度流程列表) {
                const input = document.createElement('input')
                input.type = 'radio'
                input.id = 练度流程name
                input.name = "练度流程"
                input.value = 练度流程name
                input.onchange = () => 切换配置(练度流程name)
                if (练度流程name == config) {
                    input.checked = true
                }
                const label = document.createElement('label')
                label.htmlFor = 练度流程name
                label.innerHTML = 练度流程列表[练度流程name].标题 + '<br/>'
                form_ele.appendChild(input)
                form_ele.appendChild(label)
            }

            if (config)
                切换配置(config)
        }


    </script>
</body>

</html>